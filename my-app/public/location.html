<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Device Location</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 600px; /* Set the height of the map */
            width: 100%; /* Set the width of the map */
        }
        body {
            background-color: #f8d7da; /* Pink background */
            color: #721c24; /* Dark text color for visibility */
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <h1>Your Device Location</h1>
    <p>Here, you can find shelters near your precise location! Click on the blue icons to find information on a shelter's name, phone number, & address.</p>
    <div id="location"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let map; // Global map variable

        // Function to fetch device location from the backend
        async function fetchDeviceLocation() {
            console.log("Fetching device location...");

            try {
                const response = await fetch('http://localhost:5000/get-device-location'); // Ensure this URL matches your Flask backend
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                displayLocation(data); // Call displayLocation with data from the backend
                initMap(data.hard_coded); // Initialize the map with hard-coded coordinates
            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
            }
        }

        // Display the device location on the webpage
        function displayLocation(data) {
            const locationDiv = document.getElementById("location");
            locationDiv.innerHTML = `        
                <p><strong>Hard-Coded Coordinates:</strong></p>
                <p><strong>Latitude:</strong> ${data.hard_coded.latitude}</p>
                <p><strong>Longitude:</strong> ${data.hard_coded.longitude}</p>
                <p><strong>Civic Address:</strong> ${data.hard_coded.civic_address}</p>
                <p><strong>API Call Coordinates:</strong></p>
                <p><strong>Latitude:</strong> ${data.api_call.latitude}</p>
                <p><strong>Longitude:</strong> ${data.api_call.longitude}</p>
                <p><strong>Civic Address:</strong> ${data.api_call.civic_address || 'N/A'}</p>
            `;
        }

        // Initialize the Leaflet map
        function initMap(hardCodedData) {
            const lat = hardCodedData.latitude;
            const lon = hardCodedData.longitude;

            // Create a new map instance centered on the hard-coded coordinates
            map = L.map("map").setView([lat, lon], 13);

            // Load and display a tile layer
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution: "Â© OpenStreetMap",
            }).addTo(map);

            // Add a marker for the hard-coded location
            const hardCodedMarker = L.marker([lat, lon]).addTo(map);
            hardCodedMarker.bindPopup("Hard-Coded Location: Husky Union Building").openPopup();

            // Add the shelter markers
            addSheltersToMap(map);
        }

        // Function to get the user's location and homeless shelters
        const shelters = [
            {"name": "Roots Young Adult Shelter", "latitude": 47.66248127145029, "longitude": -122.3072860470316, "address": "4541 19th Ave NE, Seattle, WA 98105", "phone": "+12066321635"},
            {"name": "Elizabeth Gregory Home", "latitude": 47.66586714776774, "longitude": -122.30749287743375, "address": "1911 Aurora Ave N, Seattle, WA 98109", "phone": "+12067290262"},
            {"name": "U-District Youth Center", "latitude": 47.6615, "longitude": -122.3171, "address": "5031 University Way NE, Seattle, WA 98105", "phone": "+12066116230"},
            {"name": "Lifewire - Transitional Housing", "latitude": 47.6622, "longitude": -122.3213, "address": "2016 72nd Ave NE, Seattle, WA 98115", "phone": "+12063681873"},
            {"name": "The Salvation Army - Seattle", "latitude": 47.6577, "longitude": -122.3297, "address": "1101 W. 15th Ave, Seattle, WA 98122", "phone": "+12064417147"},
            {"name": "Y-Women's Shelter", "latitude": 47.6610, "longitude": -122.3250, "address": "1515 2nd Ave, Seattle, WA 98101", "phone": "+12063268918"},
            {"name": "New Horizons", "latitude": 47.6572, "longitude": -122.3170, "address": "4526 8th Ave NE, Seattle, WA 98105", "phone": "+12062659111"}
        ];

        function addSheltersToMap(map) {
            shelters.forEach((shelter) => {
                const marker = L.marker([shelter.latitude, shelter.longitude], {
                    color: 'green'
                }).addTo(map);
                marker.bindPopup(
                    `<b>${shelter.name}</b><br>Address: ${shelter.address}<br>Phone: ${shelter.phone}`
                );
            });
        }

        // Show the user's position on the map
        function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            // Add a marker at the user's location
            const marker = L.marker([lat, lon]).addTo(map);
            marker.bindPopup("You are here!").openPopup();
        }

        // Handle errors
        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("User denied the request for Geolocation.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("Location information is unavailable.");
                    break;
                case error.TIMEOUT:
                    alert("The request to get user location timed out.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("An unknown error occurred.");
                    break;
            }
        }

        // Call the function to get the user's location
        async function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        // Initialize the app by fetching device location and user location
        fetchDeviceLocation();
        getUserLocation();
    </script>
</body>
</html>
